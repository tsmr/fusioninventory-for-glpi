function pin_agent(a){var b=a.chart_id,c=a.data[0],d=taskjobs.agents_chart[b];d.pinned_agents[c]=d.agents.toObject()[c],d.pinned_agents[c].logs={},taskjobs.refresh_pinned_agents(b)}function add_runlogs(a){return function(b,c,d){var e=taskjobs.agents_chart[a.chart_id],f=e.pinned_agents[a.agent_id];f&&(f.logs[a.i]=b,agents_dispatch.view(a.chart_id))}}function unpin_agent(a){var b=a.chart_id,c=a.data[0];delete taskjobs.agents_chart[b].pinned_agents[c],agents_dispatch.view(b)}function agent_is_pinned(a){var b=a.chart_id,c=a.data[0];return taskjobs.agents_chart[b].pinned_agents[c]}function agents_chart(a){function b(b){b.each(function(b,c){var d=d3.select(this).selectAll("div.agent_block").data(b);d.enter().append("div"),d.attr("class",function(b){var c=["agent_block"];agent_is_pinned({chart_id:a,data:b})&&c.push("pinned");b[1].length;return c.push("agent_"+b[1][0].state),c.join(" ")}).each(function(b){var c=d3.select(this).selectAll("a.link").data([b]);c.enter().append("a").attr("class","link btn").attr("href",b[1][0].link);var d=d3.select(this).selectAll("input").data([b]);d.enter().append("input").attr("type","checkbox").attr("class","check_restart").attr("value",b[0]).on("click",function(b){var c=taskjobs.agents_chart[a],d=b[1][0].agent_id;$(this).is(":checked")?c.checked_agents[d]=d:delete c.checked_agents[d],taskjobs.update_agents_view(a)});var e=d3.select(this).selectAll("a.name").data([b]);e.enter().append("a").attr("class","name").on("click",function(b){var c={chart_id:a,data:b};agent_is_pinned(c)?unpin_agent(c):pin_agent(c)}),e.exit().remove(),e.attr("href","javascript:void(0)").text(taskjobs.data.agents[b[0]]);var f=d3.select(this).selectAll("span.date").data([b]);f.enter().append("span").attr("class","date"),f.html([b[1][0].last_log_date].join("<br/>"));var g=d3.select(this).selectAll("span.comment").data([b]);if(g.enter().append("span").attr("class","comment"),g.text(function(a){return[a[1][0].last_log+" "].join(",")}),g.exit().remove(),"error"==b[1][0].state){d3.select(this).selectAll("a.restart").data([b]);e.enter().append("a").attr("class","restart btn").attr("title","restart").on("click",function(a){$.ajax({url:"../ajax/restart_job.php",data:{jobstate_id:a[1][0].jobstate_id,agent_id:a[1][0].agent_id},complete:function(){taskjobs.queue_refresh_logs(taskjobs.ajax_url,taskjobs.task_id)}})}),e.exit().remove(),e.attr("href","javascript:void(0)")}args={chart_id:a,data:b};var i=d3.select(this).selectAll("table.runs").data([agent_is_pinned(args)].filter(function(a){return!(!a||!a.logs)}));i.exit().remove(),i.enter().append("table").attr("class","runs"),i.each(function(a){var b=[];$.each(a.logs,function(a,c){b.push("<tr class='run header'><th colspan='3'>"+c.run+"</th></tr>"),$.each(c.logs,function(a,c){b.push("<tr class='run log'><td>"+c["log.date"]+"</td><td>"+taskjobs.logstatuses_names[c["log.state"]]+"</td><td class='comment'>"+c["log.comment"]+"</td></tr>")}),b.push("<tr class='run'><td class='void' colspan='4'></td></tr>")}),$(this).html(b.join("\n"))})}),d.exit().remove()})}return b}var taskjobs={};taskjobs.show_form=function(a,b,c){$("#taskjobs_form").html(a)},taskjobs.hide_form=function(){$("#taskjobs_form").html("")},taskjobs.register_update_method=function(a){$("#"+a).off("change","*").on("change",function(a){$("#method_selected").text(a.val),taskjobs.hide_moduletypes_dropdown(),taskjobs.hide_moduleitems_dropdown(),taskjobs.clear_list("targets"),taskjobs.clear_list("actors")})},taskjobs.register_update_items=function(a,b,c,d){$("#"+a).off("change","*").on("change",function(a){taskjobs.show_moduleitems(c,b,a.val,d)})},taskjobs.register_form_changed=function(){$("form[name=form_taskjob]").off("change","*").on("change",function(a){$("#cancel_job_changes_button").show()})},taskjobs.create=function(a,b){$.ajax({url:a,data:{task_id:b},success:taskjobs.show_form})},taskjobs.edit=function(a,b){$.ajax({url:a,data:{id:b},success:taskjobs.show_form})},taskjobs.hide_moduletypes_dropdown=function(){$("#taskjob_moduletypes_dropdown").html("")},taskjobs.show_moduletypes_dropdown=function(a){$("#taskjob_moduletypes_dropdown").html(a)},taskjobs.hide_moduleitems_dropdown=function(){$("#taskjob_moduleitems_dropdown").html("")},taskjobs.show_moduleitems_dropdown=function(a){$("#taskjob_moduleitems_dropdown").html(a)},taskjobs.clear_list=function(a){$("#taskjob_"+a+"_list").html("")},taskjobs.delete_items_selected=function(a){$("#taskjob_"+a+"_list").find(".taskjob_item").has("input[type=checkbox]:checked").remove()},taskjobs.add_item=function(a,b,c,d,e){item_id=$("#"+e).val();var f=200;for(deb=0,fin=0;item_id.length>deb;)item_id.length<=fin?fin+=item_id.length:fin+=f,$.ajax({url:a,data:{moduletype:b,itemtype:c,item_id:item_id.slice(deb,fin)},success:function(a,e,f){data=JSON.parse(a);for(var g=0;g<data.length;g++)item_to_add={id:c+"-"+data[g].id,name:data[g].name},item_exists=$("#taskjob_"+b+"_list").find("#"+item_to_add.id),0==item_exists.length?$("#taskjob_"+b+"_list").append("<div class='taskjob_item new' id='"+item_to_add.id+"'  >  <input type='checkbox'>  </input>  <span class='"+c+"'></span>  <label>     <span style='font-style:oblique'>"+d+"</span>     "+item_to_add.name+"  </label>  <input type='hidden' name='"+b+"[]' value='"+item_to_add.id+"'>  </input></div>"):item_exists.fadeOut(100).fadeIn(100)}}),deb=fin},taskjobs.show_moduletypes=function(a,b,c,d){taskjobs.hide_moduletypes_dropdown(),taskjobs.hide_moduleitems_dropdown(),$.ajax({url:a,data:{moduletype:b,method:$("#method_selected").text(),id:d},success:function(a,b,c){taskjobs.show_moduletypes_dropdown(a)}})},taskjobs.show_moduleitems=function(a,b,c,d){taskjobs.hide_moduleitems_dropdown(),$.ajax({url:a,data:{itemtype:c,moduletype:b,method:$("#method_selected").text(),id:d},success:function(a,b,c){taskjobs.show_moduleitems_dropdown(a)}})},taskjobs.Queue=$({refresh:0,timer:null}),taskjobs.unfolds={targets:{},agents:{},executions:{}};var agents_dispatch=d3.dispatch("view");taskjobs.refresh_pinned_agents=function(a){var b=taskjobs.agents_chart[a];$.each(b.pinned_agents,function(b,c){if(c){var d=Math.min(c.length,include_old_jobs);for(d==-1&&(d=c.length),i=0;i<d&&!(i>0&&c.length>1&&c[i].jobstate_id==c[i-1].jobstate_id);i++)$.ajax({url:"../ajax/jobstates_logs.php",data:{id:c[i].jobstate_id,last_date:c[i].last_log_date},success:add_runlogs({i:i,agent_id:b,chart_id:a})})}})},taskjobs.update_agents_view=function(a){if(taskjobs.agents_chart[a]){var b=taskjobs.agents_chart[a],c=Lazy([]),d=b.agents.toObject();Lazy(Object.keys(b.pinned_agents)).each(function(a){var c=b.pinned_agents[a].logs;b.pinned_agents[a]=d[a],b.pinned_agents[a].logs=c}),pinned_agents=Lazy(b.pinned_agents),Lazy(Object.keys(b.type_selected)).each(function(a){c=c.union(b.counters[a])}),c=c.map(function(a){return[a,!0]}).toObject();var e=b.agents.reject(function(a){return!!b.pinned_agents[a[0]]||!c[a[0]]}),f=Lazy(pinned_agents.toArray()).concat(e.toArray()).first(b.view_limit);taskjobs.agents_chart[a].filtered_agents=c,taskjobs.agents_chart[a].agents_to_view=f.toArray(),taskjobs.agents_chart[a].total_agents_to_view=e.size()+pinned_agents.size(),taskjobs.agents_chart[a].debug=e}taskjobs.agents_chart[a].display_agents=!0},taskjobs.display_agents_view=function(a){if(taskjobs.agents_chart[a].display_agents){var b=taskjobs.agents_chart[a],c=b.agents_to_view;d3.select(b.selector).datum(c).call(agents_chart(a));var d=b.total_agents_to_view-c.length,e=10,f=[];e=d>0?Math.min(d,10):0,f=[{text:"Show "+e+" more ("+d+" left)",limit:e}];var g=$(b.selector).parent()[0],h=d3.select(g).selectAll("div.show_more").selectAll("input.restart").data(f);h.enter().append("input"),h.exit().remove(),h.attr("type","button").attr("class","submit restart").attr("value","Restart selected jobs").style("display",function(a){return Object.keys(b.checked_agents).length>0?null:"none"}).on("click",function(a){$(".refresh_button > span").addClass("fetching");var c=[];$("input.check_restart:checked").each(function(a){var d=$(this).parent().index(),e=b.agents.toArray();c.push({agent_id:e[d][1][0].agent_id,jobstate_id:e[d][1][0].jobstate_id})}),$.ajax({url:"../ajax/restart_job.php",method:"post",data:{params:c},complete:function(){taskjobs.queue_refresh_logs(taskjobs.ajax_url,taskjobs.task_id),$("input.check_restart:checked").each(function(){$(this).attr("checked",!1)}),$(".refresh_button > span").removeClass("fetching")}})});var i=d3.select(g).selectAll("div.show_more").selectAll("input.more_button").data(f);i.enter().append("input").attr("type","button").attr("class","submit more_button").on("click",function(b){taskjobs.agents_chart[a].view_limit+=b.limit,taskjobs.update_agents_view(a)}),i.exit().remove(),i.style("display",function(a){return d>0?null:"none"}).attr("disabled",function(a){return a.limit>0?null:"disabled"}).attr("value",function(a){return a.text});var j=d3.select(g).selectAll("div.show_more").selectAll("input.reset_button").data(f);j.enter().append("input").attr("type","button").attr("class","submit reset_button").on("click",function(b){taskjobs.agents_chart[a].view_limit=10,taskjobs.update_agents_view(a)}),j.exit().remove(),j.style("display",function(a){return c.length>10?null:"none"}).attr("value","Reset view"),taskjobs.agents_chart[a].display_agents=!1}},agents_dispatch.on("view",function(a){taskjobs.update_agents_view(a)}),taskjobs.toggle_details_type=function(a,b,c){view=!1,a._view&&(view=a._view),a._view=!view,a._view?taskjobs.agents_chart[c].type_selected[b]=!0:delete taskjobs.agents_chart[c].type_selected[b],$(a).toggleClass("expanded",a.view),agents_dispatch.view(c)},taskjobs.create_block=function(a,b,c){element=$(a),0==element.length?$(b).append($(c)):($(a).remove(),$(b).append($(c)))};var templates={},targets_cpt=0;taskjobs.init_templates=function(){templates={task:$("#template_task").html(),job:$("#template_job").html(),target:$("#template_target").html(),target_name:$("#template_target_name").html(),target_stats:$("#template_target_stats").html(),counter_block:$("#template_counter_block").html(),counter_content:$("#template_counter_content").html(),agent:$("#template_agent").html()},Lazy(templates).each(function(a){Mustache.parse(a)})},taskjobs.charts={},taskjobs.agents_chart={},taskjobs.update_logs=function(a){taskjobs.data=$.parseJSON(a),taskjobs.compute_data(),blocks_seen={tasks:[],jobs:[],targets:[],charts:[],agents_chart:[]},tasks=taskjobs.data.tasks,tasks_selector=".tasks_block",$.each(tasks,function(a,b){task_id="task_"+b.task_id,task_name=b.task_name,task_selector="#"+task_id,blocks_seen.tasks.push(task_selector),taskjobs.create_block(task_selector,tasks_selector,Mustache.render(templates.task,{task_id:task_id,task_name:task_name,expanded:"true"==b.expanded?"expand":""})),jobs_selector=task_selector+" .jobs_block",$.each(b.jobs,function(a,b){job_id=b.id,job_name=b.name,job_selector="#job_"+job_id,blocks_seen.jobs.push(job_selector),taskjobs.create_block(job_selector,jobs_selector,Mustache.render(templates.job,{job_id:"job_"+job_id,job_name:job_name})),targets_selector=job_selector+" .targets_block",$.each(b.targets,function(a,c){target_id=a+"_"+targets_cpt,targets_cpt++,target_name=c.name,target_link=c.item_link,target_selector=task_selector+" #"+target_id,blocks_seen.targets.push(target_selector);var d="job_"+b.id+"_"+target_id;taskjobs.create_block(target_selector,targets_selector,Mustache.render(templates.target,{target_id:target_id,target_link:target_link,target_name:target_name})),agents_selector=target_selector+" .agents_block";var e=null;e=Object.keys(c.agents).length>0?c.agents:Lazy(new Object),taskjobs.agents_chart[d]||(taskjobs.agents_chart[d]={selector:agents_selector,type_selected:{},pinned_agents:{},checked_agents:{},view_limit:10},d3.timer(function(){taskjobs.display_agents_view(d)},1e3)),taskjobs.agents_chart[d].agents=e,taskjobs.agents_chart[d].counters=c.counters_computed,taskjobs.refresh_pinned_agents(d),agents_dispatch.view(d),counters_selector=target_selector+" .target_stats",$.each(taskjobs.statuses_order,function(a,b){stats_type_selector=target_selector+" ."+a,taskjobs.create_block(stats_type_selector,counters_selector,Mustache.render(templates.target_stats,{stats_type:a})),$.each(b,function(a,b){counter_value=c.counters_computed[b],counter_type=b,counter_empty=0===counter_value.length,counter_type_name=taskjobs.statuses_names[counter_type],counter_selector=target_selector+" ."+counter_type,$(counter_selector).remove(),taskjobs.create_block(counter_selector,stats_type_selector,Mustache.render(templates.counter_block,{counter_empty:counter_empty,counter_type:counter_type,chart_id:d,counter_type_name:counter_type_name,counter_value:counter_value.length}))})});var f=[target_selector,".target_details","div.progressbar"].join(" > ");blocks_seen.charts.push("#chart_"+d),0===$("#chart_"+d).length&&(taskjobs.charts[d]=taskjobs.create_progressbar(f,"chart_"+d,400,100),taskjobs.charts[d].new_data=[0,0,0],taskjobs.update_progressbar(taskjobs.charts[d])),taskjobs.charts[d].new_data=[c.counters_computed.agents_success.length,c.counters_computed.agents_error.length,c.counters_computed.agents_notdone.length],!d3.sum(taskjobs.charts[d].new_data)>0?$(f).addClass("empty"):$(f).removeClass("empty"),$(counters_selector).show(),$(target_selector).show()}),$(job_selector).show()}),$(task_selector).show()}),$(".refresh_button span").removeClass("computing"),taskjobs.blocks_seen&&(cache=taskjobs.blocks_seen,node_to_drop=Lazy([]).concat(Lazy(cache.tasks).without(blocks_seen.tasks).toArray()).concat(Lazy(cache.jobs).without(blocks_seen.jobs).toArray()).concat(Lazy(cache.targets).without(blocks_seen.targets).toArray()).concat(Lazy(cache.charts).without(blocks_seen.charts).toArray()),$.each(node_to_drop.toArray(),function(a,b){$(b).remove()})),$(Object.keys(taskjobs.charts)).delay(500).each(function(a,b){taskjobs.update_progressbar(taskjobs.charts[b])}),taskjobs.blocks_seen=blocks_seen,taskjobs.init_tasks_expand_buttons()},taskjobs.compute_data=function(){tasks=taskjobs.data.tasks,result=[],$.each(tasks,function(a,b){task=tasks[a],$.each(task.jobs,function(a,b){job=task.jobs[a],$.each(job.targets,function(a,b){b.counters_computed={agents_prepared:Object.keys(b.counters.agents_prepared),agents_running:Object.keys(b.counters.agents_running),agents_cancelled:Object.keys(b.counters.agents_cancelled),agents_notdone:Object.keys(b.counters.agents_notdone),agents_error:Object.keys(b.counters.agents_error),agents_success:Object.keys(b.counters.agents_success)},Object.keys(b.agents).length>0&&(b.agents=Lazy(b.agents).sortBy(function(a){return a[1][0].timestamp}).reverse()),counters=b.counters_computed,counters.agents_notdone=Lazy(counters.agents_notdone).toArray(),counters.agents_total=Lazy(counters.agents_success).union(counters.agents_error).toArray()})})})},taskjobs.create_progressbar=function(a,b,c,d){var e=d3.select(a).append("svg").attr("id",b).attr("class","chart").attr("width",c).attr("height",d);return origin=e.append("g").attr("transform","translate("+c/2+","+d+")"),origin.append("g").attr("class","arcs"),origin.append("g").attr("class","pointers"),origin.append("g").attr("class","texts"),e._width=c,e},taskjobs.update_progressbar=function(a){var b=a.new_data;remapped=[];var c=0,d=d3.sum(b),e=Math.PI;d>0?(b.forEach(function(a,b){t=Math.ceil(a/d*16),remapped.push({real:a,value:t.toFixed(0),index:b,x0:c,x1:c+=+t})}),a.style("display","")):a.style("display","none");var f=80,g=d3.scale.linear().domain([0,d]).range([0,100]),h=d3.scale.ordinal().domain([0,1,2]).range(["#8F8","#F33","#ccc"]),l=(d3.scale.ordinal().domain([0,1,2]).range(["#0A0","#A00","#777"]),d3.format(".1s"),d3.layout.pie().value(function(a,b){return d>0?a.value:3==b?100:void 0}).sort(null).startAngle(-90*(e/180)).endAngle(90*(e/180))),m=d3.svg.arc().innerRadius(f-25).outerRadius(f),n=a.select("g.arcs").selectAll("path.arc").data(l(remapped));n.enter().append("path").attr("class","arc").attr("fill",function(a,b){return h(b)}).each(function(a){this._current=a});d3.dispatch("newangle");arcTween=function(a){var b=d3.interpolate(this._current,a);return this._current=b(0),function(a){return i=b(a),m(b(a))}},n.transition().duration(500).attrTween("d",arcTween),n.exit().remove(),cursorposTween=function(a){var b=d3.interpolate(this._current,a);return this._current=b(0),function(a){return"translate("+m.centroid(b(a))+")"}};var q=a.select("g.texts").selectAll("text").data(l(remapped));q.enter().append("text").attr("text-anchor","middle").attr("font-size","0.5em").each(function(a){this._current=a}),q.text(function(a){return g(a.data.real).toFixed(1)}),q.attr("display",function(a){return a.data.value>0?"":"none"}),q.transition().duration(500).attrTween("transform",cursorposTween),q.exit().remove()},taskjobs.get_logs=function(a,b){$(".refresh_button > span").addClass("fetching").removeClass("computing");var c={task_id:b,include_old_jobs:include_old_jobs};$.ajax({url:a,data:c,success:function(c,d,e){$(".refresh_button > span").addClass("computing").removeClass("fetching"),setTimeout(function(){taskjobs.update_logs(c),taskjobs.update_refresh_buttons(a,b)},50)},complete:function(){taskjobs.init_include_old_jobs_buttons(a,b),taskjobs.Queue.queue("refresh_logs").pop()}})},taskjobs.update_refresh_buttons=function(a,b){$(".refresh_button").off("click").on("click",function(c){taskjobs.queue_refresh_logs(a,b)})},taskjobs.init_include_old_jobs_buttons=function(a,b){$(".include_old_jobs").off("click").on("change",function(c){include_old_jobs=$(this).val(),taskjobs.queue_refresh_logs(a,b)})},taskjobs.init_tasks_expand_buttons=function(){$(".monitoring-logs .task_block > h3").off("click").on("click",function(a){$(this).parent().toggleClass("expand");var b=$(this).parent().attr("id"),c=b.replace("task_","");$.ajax({url:"../ajax/expand_task.php",data:{task_id:c,expanded:$(this).parent().hasClass("expand")}})})},taskjobs.init_refresh_form=function(a,b,c){$("#"+c).off("change").on("change",function(){taskjobs.update_logs_timeout(a,b,c)})},taskjobs.update_logs_timeout=function(a,b,c){taskjobs.refresh=$("#"+c).val(),window.clearTimeout(taskjobs.Queue.timer),taskjobs.queue_refresh_logs(a,b),"off"!=taskjobs.refresh?(taskjobs.Queue.refresh=1e3*taskjobs.refresh,taskjobs.Queue.timer=window.setInterval(function(){taskjobs.queue_refresh_logs(a,b)},taskjobs.Queue.refresh)):window.clearTimeout(taskjobs.Queue.timer)},taskjobs.queue_refresh_logs=function(a,b){var c=taskjobs.Queue.queue("refresh_logs");$(".tasks_block:hidden").remove(),0===$(".tasks_block:visible").length&&window.clearTimeout(taskjobs.Queue.timer),0===c.length&&(taskjobs.Queue.queue("refresh_logs",function(){taskjobs.get_logs(a,b)}),taskjobs.Queue.queue("refresh_logs")[0]())};